name: Test
on:
  push:
permissions:
  contents: read
jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      lib: ${{ steps.paths-filter.outputs.lib }}
      python: ${{ steps.paths-filter.outputs.python }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - uses: dorny/paths-filter@v3
        id: paths-filter
        with:
          filters: |
            lib:
              - 'mvsr/**'
            python:
              - 'lang/python/**'
  build-lib:
    name: Build ${{ needs.detect-changes.outputs.lib == 'true' && 'and Test ' }}C++ Library
    permissions:
      actions: write
      contents: read
    needs: detect-changes
    if: needs.detect-changes.outputs.lib == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-13, macos-latest]
    uses: ./.github/workflows/lib.yaml
    with:
      runner: ${{ matrix.os }}
      run-tests: ${{ needs.detect-changes.outputs.lib == 'true' }}
  python-test:
    name: Test Python
    needs: [detect-changes, build-lib]
    if: needs.detect-changes.outputs.python == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-13, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false
    - uses: astral-sh/setup-uv@v6
    - uses: actions/download-artifact@v4
      with:
        name: lib-${{ matrix.os }}
        path: /tmp/artifact
    - name: Copy built library to package
      run: cp -r /tmp/artifact/${{ runner.os != 'Windows' && 'lib' || 'bin' }} lang/python/mvsr/lib
    - uses: wntrblm/nox@main
    - name: Run coverage tests
      working-directory: lang/python/test
      run: nox -s test_simple
  python-coverage:
    name: Test Python Coverage
    needs: [detect-changes, build-lib]
    if: needs.detect-changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false
    - uses: astral-sh/setup-uv@v6
    - uses: actions/download-artifact@v4
      with:
        name: lib-ubuntu-latest
        path: /tmp/artifact
    - name: Copy built library to package
      run: cp -r /tmp/artifact/lib lang/python/mvsr/lib
    - uses: wntrblm/nox@main
    - name: Run coverage tests
      working-directory: lang/python/test
      run: nox -s coverage
