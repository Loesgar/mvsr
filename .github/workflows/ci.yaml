name: Test
on:
  push:
permissions:
  contents: read
jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      lib: ${{ steps.paths-filter.outputs.lib }}
      python: ${{ steps.paths-filter.outputs.python }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - uses: dorny/paths-filter@v3
        id: paths-filter
        with:
          filters: |
            global: &global
              - .github/workflows/ci.yaml
              - .github/workflows/lib.yaml
              - flake.*
            lib-direct: &lib-direct
              - *global
              - mvsr/**
            python: &python
              - *global
              - lang/python/**
            lib:
              - *lib-direct
              - *python
  build-lib:
    name: Build ${{ needs.changes.outputs.lib-direct == 'true' && 'and Test ' }}C++ Library
    permissions:
      actions: write
      contents: read
    needs: changes
    if: needs.changes.outputs.lib == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-latest] # , ubuntu-24.04-arm, windows-latest
    uses: ./.github/workflows/lib.yaml
    with:
      runner: ${{ matrix.os }}
      run-tests: ${{ needs.changes.outputs.lib-direct == 'true' }}
  python-test:
    name: Test Python
    needs: [changes, build-lib]
    if: needs.changes.outputs.python == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-latest] # , ubuntu-24.04-arm, windows-latest
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false
    - uses: astral-sh/setup-uv@v6
    - uses: actions/download-artifact@v4
      with:
        name: lib-${{ matrix.os }}
        path: /tmp/artifact
    - name: Copy built library to package
      run: cp -r /tmp/artifact/${{ runner.os != 'Windows' && 'lib' || 'bin' }} lang/python/mvsr/lib
    - uses: wntrblm/nox@main
    - name: Run coverage tests
      working-directory: lang/python/test
      run: nox -s test_simple
  python-coverage:
    name: Test Python Coverage
    needs: [changes, build-lib]
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false
    - uses: astral-sh/setup-uv@v6
    - uses: actions/download-artifact@v4
      with:
        name: lib-ubuntu-latest
        path: /tmp/artifact
    - name: Copy built library to package
      run: cp -r /tmp/artifact/lib lang/python/mvsr/lib
    - uses: wntrblm/nox@main
    - name: Run coverage tests
      working-directory: lang/python/test
      run: nox -s coverage
